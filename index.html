<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fullscreen Camera Stream</title>

  <!-- Video.js CSS -->
  <link href="https://vjs.zencdn.net/8.0.4/video-js.css" rel="stylesheet">

  <!-- Dark Theme Styling -->
  <style>
    :root {
      --background-color: #121212;
      --text-color: #ffffff;
      --button-bg: rgba(31, 31, 31, 0.8);
      --button-hover-bg: rgba(51, 51, 51, 0.8);
      --font-family: Arial, sans-serif;
      --modal-background: rgba(0, 0, 0, 0.8);
      --modal-content-bg: #1f1f1f;
      --modal-text-color: #ffffff;
      --fps-bg: rgba(0, 0, 0, 0.5);
      --button-font-size: 16px;
      --button-padding: 12px 24px;
    }

    /* Reset and Base Styles */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      background-color: var(--background-color);
      color: var(--text-color);
      font-family: var(--font-family);
      position: relative;
    }

    /* Video Container */
    #camera-stream {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: black;
      max-width: 100%;
      max-height: 100%;
    }

    /* Controls Styling */
    .controls {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 2;
    }

    .control-button {
      background-color: var(--button-bg);
      border: none;
      border-radius: 25px;
      color: var(--text-color);
      padding: var(--button-padding);
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: var(--button-font-size);
      min-width: 120px;
      text-align: center;
    }

    .control-button:hover {
      background-color: var(--button-hover-bg);
    }

    /* FPS Counter */
    #fps-counter {
      position: fixed;
      bottom: 20px;
      left: 20px;
      color: #fff;
      background: var(--fps-bg);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 2;
    }

    /* Loading Indicator */
    #loading-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-color);
      background: rgba(0, 0, 0, 0.7);
      padding: 20px 30px;
      border-radius: 10px;
      display: none;
      z-index: 3;
      font-size: 18px;
    }

    /* Modal Styling */
    .modal {
      display: none;
      position: fixed;
      z-index: 4;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: var(--modal-background);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: var(--modal-content-bg);
      color: var(--modal-text-color);
      padding: 20px 30px;
      border: 1px solid #888;
      border-radius: 10px;
      width: 80%;
      max-width: 400px;
      position: relative;
      text-align: center;
    }

    .close-button {
      color: var(--modal-text-color);
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 20px;
      cursor: pointer;
    }

    .close-button:hover,
    .close-button:focus {
      color: #bbb;
      text-decoration: none;
    }

    .modal-message {
      margin-top: 40px;
      font-size: 18px;
    }

    .modal-options {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .modal-option {
      background-color: var(--button-bg);
      border: none;
      border-radius: 5px;
      color: var(--text-color);
      padding: 10px 20px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 16px;
      width: 100%;
      max-width: 300px;
    }

    .modal-option:hover {
      background-color: var(--button-hover-bg);
    }

    /* Responsive Adjustments */
    @media (max-width: 600px) {
      .control-button {
        padding: 10px 20px;
        font-size: 14px;
        min-width: 100px;
      }

      .modal-content {
        width: 90%;
        padding: 15px 20px;
      }

      .modal-option {
        font-size: 14px;
        padding: 8px 16px;
      }

      #loading-indicator {
        padding: 15px 25px;
        font-size: 16px;
      }

      #fps-counter {
        font-size: 12px;
        padding: 4px 8px;
      }
    }
  </style>

  <!-- Video.js Library -->
  <script src="https://vjs.zencdn.net/8.0.4/video.min.js" defer></script>
</head>
<body>

  <!-- Loading Indicator -->
  <div id="loading-indicator">Initializing camera...</div>

  <!-- FPS Counter -->
  <div id="fps-counter">FPS: --</div>

  <!-- Video Stream -->
  <video id="camera-stream" class="video-js vjs-default-skin" autoplay muted playsinline></video>

  <!-- Controls -->
  <div class="controls">
    <button class="control-button" id="change-camera" aria-label="Change Camera">Change Camera</button>
    <button class="control-button" id="change-resolution" aria-label="Change Resolution">Change Resolution</button>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
      <span class="close-button" id="modal-close" aria-label="Close Modal">&times;</span>
      <div class="modal-message" id="modal-message">Modal Message</div>
      <div class="modal-options" id="modal-options">
        <!-- Dynamic Options Will Be Injected Here -->
      </div>
    </div>
  </div>

  <!-- JavaScript for Functionality -->
  <script>
    (() => {
      // Utility Module
      const Utils = (() => {
        const createElement = (tag, attributes = {}, ...children) => {
          const element = document.createElement(tag);
          Object.entries(attributes).forEach(([key, value]) => {
            if (key.startsWith('data-') || key.startsWith('aria-')) {
              element.setAttribute(key, value);
            } else if (key === 'class') {
              element.className = value;
            } else if (key === 'style') {
              element.style.cssText = value;
            } else {
              element[key] = value;
            }
          });
          children.forEach(child => {
            if (typeof child === 'string') {
              element.appendChild(document.createTextNode(child));
            } else {
              element.appendChild(child);
            }
          });
          return element;
        };

        const debounce = (func, delay) => {
          let timeout;
          return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
          };
        };

        return { createElement, debounce };
      })();

      // Modal Module
      const Modal = (() => {
        const modal = document.getElementById('modal');
        const modalClose = document.getElementById('modal-close');
        const modalMessage = document.getElementById('modal-message');
        const modalOptions = document.getElementById('modal-options');

        const show = (message, options = []) => {
          modalMessage.textContent = message;
          modalOptions.innerHTML = '';
          options.forEach(option => {
            const button = Utils.createElement('button', {
              class: 'modal-option',
              onclick: option.onClick,
              'aria-label': option.label
            }, option.label);
            modalOptions.appendChild(button);
          });
          modal.style.display = 'flex';
        };

        const close = () => {
          modal.style.display = 'none';
        };

        modalClose.addEventListener('click', close);
        window.addEventListener('click', (event) => {
          if (event.target === modal) {
            close();
          }
        });

        // Accessibility: Close modal with Escape key
        window.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && modal.style.display === 'flex') {
            close();
          }
        });

        return { show, close };
      })();

      // FPS Counter Module
      const FPSCounter = (() => {
        const fpsDisplay = document.getElementById('fps-counter');
        let frameCount = 0;
        let lastTime = performance.now();

        const update = () => {
          frameCount++;
          const now = performance.now();
          if (now - lastTime >= 1000) {
            fpsDisplay.textContent = `FPS: ${frameCount}`;
            frameCount = 0;
            lastTime = now;
          }
          requestAnimationFrame(update);
        };

        const start = () => requestAnimationFrame(update);

        return { start };
      })();

      // Camera Module
      const Camera = (() => {
        const videoElement = document.getElementById('camera-stream');
        const loadingIndicator = document.getElementById('loading-indicator');
        const changeCameraBtn = document.getElementById('change-camera');
        const changeResolutionBtn = document.getElementById('change-resolution');

        let currentStream = null;
        let currentCameraIndex = parseInt(localStorage.getItem('currentCameraIndex')) || 0;
        let currentResolution = JSON.parse(localStorage.getItem('currentResolution')) || { width: 1280, height: 720 };
        let cameras = [];
        let isChangingStream = false;

        const resolutions = [
          { label: '1280x720', width: 1280, height: 720 },
          { label: '1920x1080', width: 1920, height: 1080 },
          { label: '640x480', width: 640, height: 480 }
        ];

        // Resize Video to Maintain Aspect Ratio
        const resizeVideo = () => {
          if (!videoElement.videoWidth || !videoElement.videoHeight) return;

          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;
          const videoAspectRatio = videoElement.videoWidth / videoElement.videoHeight;
          const viewportAspectRatio = viewportWidth / viewportHeight;

          if (videoAspectRatio > viewportAspectRatio) {
            videoElement.style.width = `${viewportWidth}px`;
            videoElement.style.height = `${viewportWidth / videoAspectRatio}px`;
          } else {
            videoElement.style.width = `${viewportHeight * videoAspectRatio}px`;
            videoElement.style.height = `${viewportHeight}px`;
          }

          // Center the video
          videoElement.style.top = `${viewportHeight / 2}px`;
          videoElement.style.left = `${viewportWidth / 2}px`;
        };

        // Fetch Available Cameras
        const getCameras = async () => {
          try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            cameras = devices.filter(device => device.kind === 'videoinput');
            if (cameras.length === 0) {
              Modal.show('No cameras found on this device.');
            }
          } catch (error) {
            console.error('Error enumerating devices:', error);
            Modal.show('Unable to access camera devices.');
          }
        };

        // Start Camera Stream
        const startStream = async () => {
          if (isChangingStream) return;
          isChangingStream = true;

          try {
            loadingIndicator.style.display = 'block';

            // Stop any existing stream
            if (currentStream) {
              currentStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
              video: {
                deviceId: cameras[currentCameraIndex]?.deviceId ? { exact: cameras[currentCameraIndex].deviceId } : undefined,
                facingMode: 'environment',
                width: { ideal: currentResolution.width },
                height: { ideal: currentResolution.height }
              }
            };

            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            videoElement.srcObject = currentStream;

            // Resize video once metadata is loaded
            videoElement.onloadedmetadata = () => {
              resizeVideo();
              videoElement.play();
            };
          } catch (error) {
            console.error('Error initializing video stream:', error);
            handleStreamError(error);
          } finally {
            loadingIndicator.style.display = 'none';
            isChangingStream = false;
          }
        };

        // Handle Stream Errors
        const handleStreamError = (error) => {
          if (error.name === 'NotAllowedError') {
            Modal.show('Camera access was denied. Please enable it in your browser settings.');
          } else if (error.name === 'NotFoundError') {
            Modal.show('No camera device found. Please connect a camera and try again.');
          } else {
            Modal.show('An unexpected error occurred while accessing the camera.');
          }
        };

        // Change Camera Handler
        const changeCamera = () => {
          if (cameras.length < 2) {
            Modal.show('No alternative cameras available.');
            return;
          }

          const cameraOptions = cameras.map((camera, index) => ({
            label: camera.label || `Camera ${index + 1}`,
            onClick: () => {
              currentCameraIndex = index;
              localStorage.setItem('currentCameraIndex', currentCameraIndex);
              Modal.close();
              startStream();
            }
          }));

          Modal.show('Select a camera:', cameraOptions);
        };

        // Change Resolution Handler
        const changeResolution = () => {
          if (!resolutions.length) {
            Modal.show('No resolutions available to choose from.');
            return;
          }

          const resolutionOptions = resolutions.map(res => ({
            label: res.label,
            onClick: async () => {
              currentResolution = { width: res.width, height: res.height };
              localStorage.setItem('currentResolution', JSON.stringify(currentResolution));
              Modal.close();
              await startStream();
            }
          }));

          Modal.show('Select a resolution:', resolutionOptions);
        };

        // Initialize Camera Permissions and Stream
        const initialize = async () => {
          try {
            const permissionStatus = await navigator.permissions.query({ name: 'camera' });

            if (permissionStatus.state === 'denied') {
              Modal.show('Camera access is denied. Please enable it in your browser settings.');
            } else if (permissionStatus.state === 'prompt') {
              await navigator.mediaDevices.getUserMedia({ video: true });
              Modal.show('Camera access granted. The page will now refresh to start the camera stream.', [
                {
                  label: 'Continue',
                  onClick: () => {
                    Modal.close();
                    location.reload();
                  }
                }
              ]);
            } else if (permissionStatus.state === 'granted') {
              await getCameras();
              await startStream();
            }

            // Listen for permission changes
            permissionStatus.onchange = async () => {
              if (permissionStatus.state === 'granted') {
                Modal.show('Camera access granted. The page will now refresh to start the camera stream.', [
                  {
                    label: 'Continue',
                    onClick: () => {
                      Modal.close();
                      location.reload();
                    }
                  }
                ]);
              } else if (permissionStatus.state === 'denied') {
                Modal.show('Camera access has been denied. Please enable it in your browser settings.');
              }
            };
          } catch (error) {
            console.error('Error checking camera permissions:', error);
            Modal.show('An error occurred while accessing camera permissions.');
          }
        };

        // Event Listeners
        const setupEventListeners = () => {
          window.addEventListener('resize', resizeVideo);

          changeCameraBtn.addEventListener('click', Utils.debounce(changeCamera, 300));
          changeResolutionBtn.addEventListener('click', Utils.debounce(changeResolution, 300));

          navigator.mediaDevices.ondevicechange = async () => {
            await getCameras();
          };

          window.addEventListener('load', initialize);
        };

        // Public API
        return { setupEventListeners, startStream, getCameras };
      })();

      // Initialize Modules
      FPSCounter.start();
      Camera.setupEventListeners();

    })();
  </script>

</body>
</html>
